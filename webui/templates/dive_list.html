{% extends "base.html" %}

{% block title %}Dive Log - Subsurface{% endblock %}

{% block stats_bar %}
<div class="stats-bar">
    <div class="container">
        <div class="stats-grid">
            <div class="stat">
                <div class="stat-value">{{ total_dives }}</div>
                <div class="stat-label">Total Dives</div>
            </div>
            <div class="stat">
                <div class="stat-value">{{ total_trips }}</div>
                <div class="stat-label">Trips</div>
            </div>
            {% if statistics.total_dive_time_minutes %}
            <div class="stat">
                <div class="stat-value">{{ (statistics.total_dive_time_minutes / 60)|round(0)|int }}<span class="data-unit">h</span></div>
                <div class="stat-label">Total Time</div>
            </div>
            {% endif %}
            {% if statistics.max_depth_meters %}
            <div class="stat">
                <div class="stat-value">{{ statistics.max_depth_meters|round(1) }}<span class="data-unit">m</span></div>
                <div class="stat-label">Max Depth</div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .page-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-lg);
    }

    .page-title h1 {
        margin-bottom: 0;
    }

    /* Trip items keep the old card style */
    .trip-item {
        display: block;
        padding: var(--space-lg) var(--space-xl);
        border-bottom: 1px solid var(--border-subtle);
        transition: all 0.2s ease;
        text-decoration: none;
    }

    .trip-item:hover {
        background: rgba(69, 121, 172, 0.08);
    }

    .trip-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-lg);
    }

    .trip-info {
        display: flex;
        align-items: center;
        gap: var(--space-md);
    }

    .trip-title {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-primary);
    }

    .trip-item:hover .trip-title {
        color: var(--brand-light);
    }

    .dive-count {
        font-weight: 400;
        color: var(--text-secondary);
    }

    .trip-dates {
        font-family: var(--font-mono);
        font-size: 0.85rem;
        color: var(--text-secondary);
        white-space: nowrap;
    }

    /* Dive table layout */
    .dive-table-container {
        margin: 0 calc(-1 * var(--space-xl));
    }

    .dive-list {
        list-style: none;
    }

    .dive-row {
        display: grid;
        grid-template-columns: 40px 140px 1fr 65px 55px 130px 60px 50px 90px;
        gap: var(--space-sm);
        align-items: center;
        padding: var(--space-sm) var(--space-xl);
        border-bottom: 1px solid var(--border-subtle);
        text-decoration: none;
        transition: background 0.2s ease;
        font-size: 0.9rem;
    }

    .dive-row:hover {
        background: rgba(69, 121, 172, 0.08);
    }

    li:last-child > .dive-row {
        border-bottom: none;
    }

    /* Column header */
    .dive-header-row {
        display: grid;
        grid-template-columns: 40px 140px 1fr 65px 55px 130px 60px 50px 90px;
        gap: var(--space-sm);
        padding: var(--space-sm) var(--space-xl);
        border-bottom: 1px solid var(--border-subtle);
        font-size: 0.7rem;
        font-weight: 600;
        color: var(--text-dim);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: rgba(0, 0, 0, 0.2);
    }

    .col-number {
        font-family: var(--font-mono);
        color: var(--text-dim);
        font-size: 0.85rem;
        text-align: right;
    }

    .col-date {
        font-family: var(--font-mono);
        color: var(--text-secondary);
        font-size: 0.85rem;
    }

    .col-location {
        display: flex;
        align-items: center;
        gap: var(--space-sm);
        color: var(--text-primary);
        font-weight: 500;
        min-width: 0;
    }

    .col-location span {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .dive-row:hover .col-location {
        color: var(--brand-light);
    }

    .col-depth, .col-duration {
        font-family: var(--font-mono);
        color: var(--brand-light);
        text-align: right;
    }

    .col-buddy {
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .col-gas {
        font-family: var(--font-mono);
        color: var(--accent-teal);
        font-size: 0.85rem;
    }

    .col-sac {
        font-family: var(--font-mono);
        color: var(--text-secondary);
        text-align: right;
        font-size: 0.85rem;
    }

    .col-tags {
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
    }

    .mini-tag {
        font-size: 0.7rem;
        padding: 1px 6px;
        background: rgba(69, 121, 172, 0.2);
        border-radius: 3px;
        color: var(--brand-light);
    }

    /* Responsive: hide columns from right as screen narrows */
    @media (max-width: 1100px) {
        .dive-row, .dive-header-row {
            grid-template-columns: 40px 140px 1fr 65px 55px 130px 60px 50px;
        }
        .col-tags, .dive-header-row > :nth-child(9) {
            display: none;
        }
    }

    @media (max-width: 950px) {
        .dive-row, .dive-header-row {
            grid-template-columns: 40px 140px 1fr 65px 55px 130px 60px;
        }
        .col-sac, .dive-header-row > :nth-child(8) {
            display: none;
        }
    }

    @media (max-width: 850px) {
        .dive-row, .dive-header-row {
            grid-template-columns: 40px 140px 1fr 65px 55px 130px;
        }
        .col-gas, .dive-header-row > :nth-child(7) {
            display: none;
        }
    }

    @media (max-width: 700px) {
        .dive-row, .dive-header-row {
            grid-template-columns: 40px 120px 1fr 60px 50px;
        }
        .col-buddy, .dive-header-row > :nth-child(6) {
            display: none;
        }
        .col-date {
            font-size: 0.8rem;
        }
    }

    @media (max-width: 500px) {
        .dive-row, .dive-header-row {
            grid-template-columns: 40px 1fr 55px 50px;
        }
        .col-date {
            display: none;
        }
        .dive-header-row > :nth-child(2) {
            display: none;
        }
    }

    .empty-state {
        text-align: center;
        padding: var(--space-2xl);
        color: var(--text-dim);
    }

    .empty-state p {
        font-size: 1.1rem;
    }

    .loading-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-md);
        padding: var(--space-xl);
        color: var(--text-dim);
    }

    .loading-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-subtle);
        border-top-color: var(--brand-light);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .end-of-list {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-lg);
        color: var(--text-dim);
        font-size: 0.9rem;
        border-top: 1px solid var(--border-subtle);
        margin-top: var(--space-md);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-title">
    <h1>Recent Dives</h1>
</div>

{% if items %}
{% set has_dives = items | selectattr('type', 'equalto', 'dive') | list | length > 0 %}
<div class="dive-table-container">
    {% if has_dives %}
    <!-- Column headers - only show if there are dives -->
    <div class="dive-header-row">
        <span style="text-align: right;">#</span>
        <span>Date</span>
        <span>Location</span>
        <span style="text-align: right;">Depth</span>
        <span style="text-align: right;">Duration</span>
        <span>Buddy</span>
        <span>Gas</span>
        <span style="text-align: right;">SAC</span>
        <span>Tags</span>
    </div>
    {% endif %}

    <ul class="dive-list">
    {% for item in items %}
    <li>
        {% if item.type == 'trip' %}
        <a href="/trip/{{ item.trip_ref }}" class="trip-item">
            <div class="trip-row">
                <div class="trip-info">
                    <span class="badge badge-trip">Trip</span>
                    <span class="trip-title">{{ item.location or item.description or 'Unnamed Trip' }} <span class="dive-count">({{ item.dive_count }} dives)</span></span>
                </div>
                <div class="trip-dates">
                    {{ item.date_start }}{% if item.date_end and item.date_end != item.date_start %} &mdash; {{ item.date_end }}{% endif %}
                </div>
            </div>
        </a>
        {% else %}
        <a href="/dive/{{ item.dive_ref }}" class="dive-row">
            <span class="col-number">{{ item.dive_number }}</span>
            <span class="col-date">{{ item.date }} {{ item.time }}</span>
            <span class="col-location">
                <span>{{ item.location or 'Unknown Location' }}</span>
            </span>
            <span class="col-depth">{{ item.max_depth_meters|round(1) if item.max_depth_meters else '-' }}<span class="data-unit">m</span></span>
            <span class="col-duration">{{ item.duration_minutes if item.duration_minutes else '-' }}<span class="data-unit">min</span></span>
            <span class="col-buddy">{{ item.buddy or '' }}</span>
            <span class="col-gas">
                {% if item.gases %}
                    {% for gas in item.gases %}
                    <span class="col-gas">{{ gas }}{% if not loop.last %},{% endif %}</span>
                    {% endfor %}
                {% endif %}
            </span>
            <span class="col-sac">{{ item.sac_rate|round(1) if item.sac_rate else '-' }}</span>
            <span class="col-tags">
                {% if item.tags %}
                    {% for tag in item.tags[:2] %}
                    <span class="mini-tag">{{ tag }}</span>
                    {% endfor %}
                {% endif %}
            </span>
        </a>
        {% endif %}
    </li>
    {% endfor %}
    </ul>

    <div id="loading-indicator" class="loading-indicator" style="display: none;">
        <div class="loading-spinner"></div>
        <span>Loading more dives...</span>
    </div>

    <div id="end-of-list" class="end-of-list" style="display: none;">
        <span>You've reached the end</span>
    </div>
</div>
{% else %}
<div class="empty-state">
    <p>No dives found.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const ITEMS_PER_PAGE = 20;
    let currentOffset = {{ items|length }};
    let isLoading = false;
    let hasMore = {{ 'true' if items|length >= 20 else 'false' }};

    const diveList = document.querySelector('.dive-list');
    const loadingIndicator = document.getElementById('loading-indicator');
    const endOfList = document.getElementById('end-of-list');

    if (!diveList) return;

    function createTripItem(item) {
        const dateRange = item.date_end && item.date_end !== item.date_start
            ? `${item.date_start} â€” ${item.date_end}`
            : item.date_start;

        return `
            <li>
                <a href="/trip/${item.trip_ref}" class="trip-item">
                    <div class="trip-row">
                        <div class="trip-info">
                            <span class="badge badge-trip">Trip</span>
                            <span class="trip-title">${item.location || item.description || 'Unnamed Trip'} <span class="dive-count">(${item.dive_count} dives)</span></span>
                        </div>
                        <div class="trip-dates">${dateRange}</div>
                    </div>
                </a>
            </li>
        `;
    }

    function createDiveItem(item) {
        const depth = item.max_depth_meters ? item.max_depth_meters.toFixed(1) : '-';
        const duration = item.duration_minutes || '-';
        const sac = item.sac_rate ? item.sac_rate.toFixed(1) : '-';
        const tags = item.tags ? item.tags.slice(0, 2).map(t => `<span class="mini-tag">${t}</span>`).join('') : '';
        const gas = item.gases ? item.gases.slice(0, 2).map(gas => `<span class="col-gas">${gas}</span>`).join(',') : '';

        return `
            <li>
                <a href="/dive/${item.dive_ref}" class="dive-row">
                    <span class="col-number">${item.dive_number || ''}</span>
                    <span class="col-date">${item.date} ${item.time}</span>
                    <span class="col-location">
                        <span>${item.location || 'Unknown Location'}</span>
                    </span>
                    <span class="col-depth">${depth}<span class="data-unit">m</span></span>
                    <span class="col-duration">${duration}<span class="data-unit">min</span></span>
                    <span class="col-buddy">${item.buddy || ''}</span>
                    <span class="col-gas">${gas}</span>
                    <span class="col-sac">${sac}</span>
                    <span class="col-tags">${tags}</span>
                </a>
            </li>
        `;
    }

    async function loadMore() {
        if (isLoading || !hasMore) return;

        isLoading = true;
        loadingIndicator.style.display = 'flex';

        try {
            const response = await fetch(`/api/dives?start=${currentOffset}&count=${ITEMS_PER_PAGE}`);
            const data = await response.json();

            if (data.status === 'error') {
                console.error('Error loading dives:', data.message);
                return;
            }

            const items = data.items || [];

            if (items.length === 0) {
                hasMore = false;
                endOfList.style.display = 'flex';
            } else {
                items.forEach(item => {
                    const html = item.type === 'trip' ? createTripItem(item) : createDiveItem(item);
                    diveList.insertAdjacentHTML('beforeend', html);
                });

                currentOffset += items.length;

                if (items.length < ITEMS_PER_PAGE) {
                    hasMore = false;
                    endOfList.style.display = 'flex';
                }
            }
        } catch (error) {
            console.error('Error loading more dives:', error);
        } finally {
            isLoading = false;
            loadingIndicator.style.display = 'none';
        }
    }

    // Intersection Observer for infinite scroll
    const sentinel = document.createElement('div');
    sentinel.id = 'scroll-sentinel';
    sentinel.style.height = '1px';
    diveList.parentNode.insertBefore(sentinel, loadingIndicator);

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && hasMore) {
            loadMore();
        }
    }, {
        rootMargin: '200px'
    });

    observer.observe(sentinel);
})();
</script>
{% endblock %}
