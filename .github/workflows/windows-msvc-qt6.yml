name: Windows MSVC

on:
  push:
    branches:
      - master
      - windows-msvc
  pull_request:
    branches:
      - master
  workflow_dispatch:
    # Manual trigger - allows running from GitHub Actions UI

env:
  # Qt version - use 6.8.x which is an LTS release (promised until 2029) and
  # includes Positioning and Location modules
  QT_VERSION: "6.8"
  QT_ARCH: "win64_msvc2022_64"
  # vcpkg configuration
  VCPKG_DEFAULT_TRIPLET: x64-windows
  # Build configuration
  BUILD_TYPE: Release

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      # ---------------------------------------------------------------
      # Install Qt via aqtinstall (includes Location, Positioning, etc.)
      # ---------------------------------------------------------------
      - name: Install Qt
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ env.QT_ARCH }}
          # Install all modules to ensure Location, Positioning, Bluetooth,
          # and other required modules are available
          modules: >-
            qtconnectivity
            qtlocation
            qtpositioning
            qt5compat
            qtwebchannel
            qtwebengine
          cache: true

      # ---------------------------------------------------------------
      # Set up vcpkg for C/C++ dependencies
      # ---------------------------------------------------------------
      - name: Set vcpkg environment
        shell: pwsh
        run: |
          # vcpkg is pre-installed on GitHub runners at C:\vcpkg
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
          # Set up binary caching directory
          echo "VCPKG_DEFAULT_BINARY_CACHE=${{ github.workspace }}\vcpkg-cache" >> $env:GITHUB_ENV

      - name: Create vcpkg cache directory
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "${{ github.workspace }}\vcpkg-cache"

      - name: Restore vcpkg cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/vcpkg-cache
          # key: vcpkg-x64-windows-${{ hashFiles('.github/workflows/windows-msvc-qt6.yml') }}
          key: vcpkg-x64-windows-v1
          restore-keys: |
            vcpkg-x64-windows-

      - name: Install vcpkg dependencies
        shell: pwsh
        run: |
          # Install all the C/C++ library dependencies Subsurface needs
          C:\vcpkg\vcpkg.exe install `
            libxml2 `
            libxslt `
            libzip `
            sqlite3 `
            libgit2 `
            libssh2 `
            curl[ssl] `
            openssl `
            libusb `
            hidapi `
            libraw `
            --triplet x64-windows

          # Print installed packages for debugging
          C:\vcpkg\vcpkg.exe list

      - name: Save vcpkg cache
        uses: actions/cache/save@v4
        if: always()
        with:
          path: ${{ github.workspace }}/vcpkg-cache
          # key: vcpkg-x64-windows-${{ hashFiles('.github/workflows/windows-msvc-qt6.yml') }}
          key: vcpkg-x64-windows-v1

      # ---------------------------------------------------------------
      # Build libdivecomputer from submodule
      # ---------------------------------------------------------------
      - name: Set up msys2 for libdivecomputer autotools
        uses: msys2/setup-msys2@v2
        with:
          install: autoconf automake libtool pkg-config make gcc

      - name: Generate libdivecomputer revision.h
        shell: msys2 {0}
        working-directory: libdivecomputer
        run: |
          autoreconf --install --force
          ./configure
          make -C src revision.h

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build libdivecomputer with MSVC
        shell: pwsh
        run: |
          $installPrefix = "${{ github.workspace }}\install"
          $vcpkgInclude = "${{ env.VCPKG_ROOT }}\installed\x64-windows\include"
          $vcpkgLib = "${{ env.VCPKG_ROOT }}\installed\x64-windows\lib"

          # Add vcpkg paths to INCLUDE and LIB environment variables
          $env:INCLUDE = "$vcpkgInclude;$env:INCLUDE"
          $env:LIB = "$vcpkgLib;$env:LIB"

          # Build libdivecomputer using the MSVC project file
          # Suppress C4996 warnings/errors about deprecated POSIX names (strdup -> _strdup, etc.)
          # /WX- disables treating warnings as errors, /wd4996 disables warning 4996
          $env:CL = "/WX- /wd4996 /D_CRT_NONSTDC_NO_WARNINGS /D_CRT_SECURE_NO_WARNINGS"
          msbuild -m -p:Platform=x64 -p:Configuration=${{ env.BUILD_TYPE }} `
            libdivecomputer/contrib/msvc/libdivecomputer.vcxproj

          # Copy the built files to install directory
          $outputDir = "libdivecomputer/contrib/msvc/x64/${{ env.BUILD_TYPE }}/bin"
          New-Item -ItemType Directory -Force -Path "$installPrefix/bin"
          New-Item -ItemType Directory -Force -Path "$installPrefix/lib"
          New-Item -ItemType Directory -Force -Path "$installPrefix/include"

          # Copy DLLs and libs
          Copy-Item "$outputDir/*.dll" -Destination "$installPrefix/bin" -ErrorAction SilentlyContinue
          Copy-Item "$outputDir/*.lib" -Destination "$installPrefix/lib" -ErrorAction SilentlyContinue

          # Copy headers (preserve libdivecomputer/ subdirectory structure)
          New-Item -ItemType Directory -Force -Path "$installPrefix/include/libdivecomputer"
          Copy-Item "libdivecomputer/include/libdivecomputer/*" -Destination "$installPrefix/include/libdivecomputer" -Recurse

      # ---------------------------------------------------------------
      # Set up MSVC environment (needed for googlemaps and Subsurface builds)
      # ---------------------------------------------------------------
      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      # ---------------------------------------------------------------
      # Build googlemaps plugin
      # ---------------------------------------------------------------
      - name: Clone googlemaps plugin
        shell: pwsh
        run: |
          git clone https://github.com/Subsurface/googlemaps.git googlemaps
          Push-Location googlemaps
          # Use qt6-upstream branch for Qt6 builds
          git checkout qt6-upstream
          Pop-Location

      - name: Build googlemaps plugin
        shell: pwsh
        run: |
          $buildDir = "${{ github.workspace }}\googlemaps\build"
          New-Item -ItemType Directory -Force -Path $buildDir
          Push-Location $buildDir

          # googlemaps uses qmake
          qmake "CONFIG+=release" ../googlemaps.pro
          nmake

          # Install the plugin to Qt's plugin directory
          nmake install

          Pop-Location

      # ---------------------------------------------------------------
      # Configure and build Subsurface
      # ---------------------------------------------------------------
      - name: Configure Subsurface
        shell: pwsh
        run: |
          $installPrefix = "${{ github.workspace }}\install"
          $buildDir = "${{ github.workspace }}\build"
          New-Item -ItemType Directory -Force -Path $buildDir
          Push-Location $buildDir

          # Set up the CMAKE_PREFIX_PATH to find all our dependencies
          $prefixPath = @(
            "$env:Qt6_DIR",
            "$installPrefix",
            "${{ env.VCPKG_ROOT }}\installed\x64-windows"
          ) -join ";"

          $vcpkgInstalled = "${{ env.VCPKG_ROOT }}\installed\x64-windows"

          cmake "${{ github.workspace }}" `
            -G Ninja `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="$prefixPath" `
            -DCMAKE_TOOLCHAIN_FILE="${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake" `
            -DSUBSURFACE_VCPKG_ROOT="${{ env.VCPKG_ROOT }}" `
            -DSUBSURFACE_TARGET_EXECUTABLE=DesktopExecutable `
            -DBUILD_WITH_QT6=ON `
            -DLIBDIVECOMPUTER_INCLUDE_DIR="$installPrefix\include" `
            -DLIBDIVECOMPUTER_LIBRARIES="$installPrefix\lib\divecomputer.lib" `
            -DLIBGIT2_INCLUDE_DIR="$vcpkgInstalled\include" `
            -DLIBGIT2_LIBRARIES="$vcpkgInstalled\lib\git2.lib" `
            -DMAKE_TESTS=OFF `
            -DNO_USERMANUAL=ON

          Pop-Location

      - name: Build Subsurface
        shell: pwsh
        run: |
          Push-Location "${{ github.workspace }}\build"
          cmake --build . --config ${{ env.BUILD_TYPE }} -j $env:NUMBER_OF_PROCESSORS
          Pop-Location

      # ---------------------------------------------------------------
      # Create installer
      # ---------------------------------------------------------------
      - name: Install NSIS
        shell: pwsh
        run: |
          choco install nsis -y
          # Add NSIS to PATH
          echo "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Create staging directory
        shell: pwsh
        run: |
          Push-Location "${{ github.workspace }}\build"
          cmake --build . --target install --config ${{ env.BUILD_TYPE }}
          Pop-Location

      - name: Populate staging with DLLs
        shell: pwsh
        run: |
          $stagingDir = "${{ github.workspace }}\build\staging"

          # Run windeployqt to gather Qt DLLs
          if (Get-Command windeployqt -ErrorAction SilentlyContinue) {
            windeployqt --release --no-translations `
              --qmldir "${{ github.workspace }}\mobile-widgets\qml" `
              "$stagingDir\subsurface.exe"
          }

          # Copy vcpkg DLLs
          $vcpkgBin = "${{ env.VCPKG_ROOT }}\installed\x64-windows\bin"
          if (Test-Path $vcpkgBin) {
            Get-ChildItem "$vcpkgBin\*.dll" | Copy-Item -Destination $stagingDir
          }

          # Copy libdivecomputer DLL
          $installBin = "${{ github.workspace }}\install\bin"
          if (Test-Path $installBin) {
            Get-ChildItem "$installBin\*.dll" | Copy-Item -Destination $stagingDir
          }

      - name: Build installer
        shell: pwsh
        run: |
          Push-Location "${{ github.workspace }}\build"
          cmake --build . --target installer --config ${{ env.BUILD_TYPE }}
          Pop-Location

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: subsurface-windows-msvc-installer
          path: ${{ github.workspace }}/build/subsurface-*.exe
